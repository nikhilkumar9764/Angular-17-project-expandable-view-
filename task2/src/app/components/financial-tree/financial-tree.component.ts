import { Component, OnInit, OnDestroy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { Subject, takeUntil } from 'rxjs';
import { FinancialDataService } from '../../services/financial-data.service';
import { FinancialNode, ApiResponse } from '../../models/financial-node.model';
import { MatTableModule, MatTableDataSource } from '@angular/material/table';
import { MatToolbarModule } from '@angular/material/toolbar';
import { CdkTableModule } from '@angular/cdk/table';
import { MatButtonModule } from '@angular/material/button';
import { MatIconModule } from '@angular/material/icon';

@Component({
  selector: 'app-financial-tree',
  standalone: true,
  imports: [CommonModule, MatTableModule, MatToolbarModule, CdkTableModule, MatButtonModule, MatIconModule],
  templateUrl: './financial-tree.component.html',
  styleUrls: ['./financial-tree.component.css']
})
export class FinancialTreeComponent implements OnInit, OnDestroy {
  dataSource = new MatTableDataSource<FinancialNode>([]);
  categorySummaries: Array<{ name: string, total: number, percentage: number }> = [];
  private destroy$ = new Subject<void>();

  displayedColumns: string[] = [
    'ccy',
    'quantity',
    'description',
    'esg',
    'cost',
    'current',
    'valuation',
    'totalCHF',
    'plTotal',
    'plYtd',
    'perc'
  ];

  private sampleData: ApiResponse = {
    "Data": {
      "Table": [{
        "RecordId": 1,
        "TreeNodeId": 833,
        "TreeNodeSort": "00010-00010",
        "Lvl1NodeOrder": 10,
        "TreeRuleDisplayName1": "Cash & Cash Equivalent",
        "Lvl2NodeOrder": 10,
        "TreeRuleDisplayName2": "Cash Accounts",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "Row1Col1": "CHF",
        "Row1Col2": 68907.500000,
        "Row1Col3": "Cash Account:  test manual Ptf.CHF",
        "Row1Col4": 0.000000,
        "Row1Col5": null,
        "Row1Col6": 68908.000000,
        "Row1Col7": 68907.500000,
        "Row1Col8": 116.801300,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "CHF Current Account",
        "Row2Col4": 0.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": null,
        "Row2Col10": null,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": "IBAN: IBAN0211",
        "Row3Col4": null,
        "Row3Col5": null,
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": -1,
        "ReportingTotalAsset": 58995.500000
      },
      {
        "RecordId": 2,
        "TreeNodeId": 833,
        "TreeNodeSort": "00010-00010",
        "Lvl1NodeOrder": 10,
        "TreeRuleDisplayName1": "Cash & Cash Equivalent",
        "Lvl2NodeOrder": 10,
        "TreeRuleDisplayName2": "Cash Accounts",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "Row1Col1": "CHF",
        "Row1Col2": -14912.000000,
        "Row1Col3": "Cash Account:  test manual Ptf.CHF",
        "Row1Col4": 0.000000,
        "Row1Col5": null,
        "Row1Col6": -14912.000000,
        "Row1Col7": -14912.000000,
        "Row1Col8": -25.276500,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "CHF Current Account-001",
        "Row2Col4": 0.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": null,
        "Row2Col10": null,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": "IBAN: IBAN0120",
        "Row3Col4": null,
        "Row3Col5": null,
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": -1,
        "ReportingTotalAsset": 58995.500000
      },
      {
        "RecordId": 3,
        "TreeNodeId": 835,
        "TreeNodeSort": "00010-00030",
        "Lvl1NodeOrder": 10,
        "TreeRuleDisplayName1": "Cash & Cash Equivalent",
        "Lvl2NodeOrder": 30,
        "TreeRuleDisplayName2": "Forwards",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "CHF",
        "Row1Col2": 5000.000000,
        "Row1Col3": "Forward",
        "Row1Col4": 0.000000,
        "Row1Col5": 1.000000,
        "Row1Col6": 5000.000000,
        "Row1Col7": 5000.000000,
        "Row1Col8": 8.475200,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": "USD",
        "Row2Col2": -2000.000000,
        "Row2Col3": "",
        "Row2Col4": 1.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": -2000.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": null,
        "Row2Col10": null,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": null,
        "Row3Col4": null,
        "Row3Col5": null,
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": -1
      },
      {
        "RecordId": 4,
        "TreeNodeId": 839,
        "TreeNodeSort": "00020-00010",
        "Lvl1NodeOrder": 20,
        "TreeRuleDisplayName1": "Liabilities",
        "Lvl2NodeOrder": 10,
        "TreeRuleDisplayName2": "Term Loan",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "CHF",
        "Row1Col2": -550000.000000,
        "Row1Col3": "Cash Account:  test manual Ptf.test manual Ptf.CHF.114888.CHF",
        "Row1Col4": 0.000000,
        "Row1Col5": 1.000000,
        "Row1Col6": -550000.000000,
        "Row1Col7": -550000.000000,
        "Row1Col8": -932.274500,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "",
        "Row2Col4": 0.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": null,
        "Row2Col10": null,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": "Maturity: 2023-11-15",
        "Row3Col4": null,
        "Row3Col5": null,
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": -1
      },
      {
        "RecordId": 5,
        "TreeNodeId": 839,
        "TreeNodeSort": "00020-00010",
        "Lvl1NodeOrder": 20,
        "TreeRuleDisplayName1": "Liabilities",
        "Lvl2NodeOrder": 10,
        "TreeRuleDisplayName2": "Term Loan",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "CHF",
        "Row1Col2": -85000.000000,
        "Row1Col3": "Cash Account:  test manual Ptf.test manual Ptf.CHF.604748.CHF",
        "Row1Col4": 0.000000,
        "Row1Col5": 1.000000,
        "Row1Col6": -85000.000000,
        "Row1Col7": -85000.000000,
        "Row1Col8": -144.078800,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "",
        "Row2Col4": 0.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": null,
        "Row2Col10": null,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": "Maturity: 2023-11-15",
        "Row3Col4": null,
        "Row3Col5": null,
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": -1
      },
      {
        "RecordId": 6,
        "TreeNodeId": 839,
        "TreeNodeSort": "00020-00010",
        "Lvl1NodeOrder": 20,
        "TreeRuleDisplayName1": "Liabilities",
        "Lvl2NodeOrder": 10,
        "TreeRuleDisplayName2": "Term Loan",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "CHF",
        "Row1Col2": -52000.000000,
        "Row1Col3": "Cash Account:  test manual Ptf.CHF",
        "Row1Col4": 0.000000,
        "Row1Col5": 1.000000,
        "Row1Col6": 0.000000,
        "Row1Col7": 0.000000,
        "Row1Col8": -88.142300,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "CHF Current Account",
        "Row2Col4": 0.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": null,
        "Row2Col10": null,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": null,
        "Row3Col4": null,
        "Row3Col5": null,
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": -1
      },
      {
        "RecordId": 7,
        "TreeNodeId": null,
        "TreeNodeSort": null,
        "Lvl1NodeOrder": null,
        "TreeRuleDisplayName1": null,
        "Lvl2NodeOrder": null,
        "TreeRuleDisplayName2": null,
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "CHF",
        "Row1Col2": -65665.000000,
        "Row1Col3": "Cash Account:  test manual Ptf.LOAN.CHF.",
        "Row1Col4": 0.000000,
        "Row1Col5": 1.000000,
        "Row1Col6": -65665.000000,
        "Row1Col7": -65665.000000,
        "Row1Col8": -111.610000,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "",
        "Row2Col4": 0.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": -179.900000,
        "Row2Col7": -180.000000,
        "Row2Col8": null,
        "Row2Col9": null,
        "Row2Col10": null,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": null,
        "Row3Col4": null,
        "Row3Col5": null,
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": -1
      },
      {
        "RecordId": 8,
        "TreeNodeId": 833,
        "TreeNodeSort": "00010-00010",
        "Lvl1NodeOrder": 10,
        "TreeRuleDisplayName1": "Cash & Cash Equivalent",
        "Lvl2NodeOrder": 10,
        "TreeRuleDisplayName2": "Cash Accounts",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "EUR",
        "Row1Col2": 50500.000000,
        "Row1Col3": "Cash Account:  test cash-0011992",
        "Row1Col4": 0.000000,
        "Row1Col5": null,
        "Row1Col6": 50500.000000,
        "Row1Col7": null,
        "Row1Col8": null,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "test cash account desc",
        "Row2Col4": 0.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": null,
        "Row2Col10": null,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": null,
        "Row3Col4": null,
        "Row3Col5": null,
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": -1
      },
      {
        "RecordId": 9,
        "TreeNodeId": 907,
        "TreeNodeSort": "00040-00040",
        "Lvl1NodeOrder": 40,
        "TreeRuleDisplayName1": "Equities",
        "Lvl2NodeOrder": 40,
        "TreeRuleDisplayName2": "Europe",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "EUR",
        "Row1Col2": 50.000000,
        "Row1Col3": "AHOLD DEL",
        "Row1Col4": 35.150000,
        "Row1Col5": 29.660000,
        "Row1Col6": 1483.000000,
        "Row1Col7": null,
        "Row1Col8": null,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "ISIN:  NL0011794037",
        "Row2Col4": 1.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": -15.620000,
        "Row2Col10": -15.620000,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": "Sector: Retail Country: Netherlands Region:  Europe",
        "Row3Col4": null,
        "Row3Col5": "2023-05-31",
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": 0
      },
      {
        "RecordId": 10,
        "TreeNodeId": 906,
        "TreeNodeSort": "00040-00030",
        "Lvl1NodeOrder": 40,
        "TreeRuleDisplayName1": "Equities",
        "Lvl2NodeOrder": 30,
        "TreeRuleDisplayName2": "Emerging Markets",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "INR",
        "Row1Col2": 20.000000,
        "Row1Col3": "HCL Technologies Ltd",
        "Row1Col4": 1145.600000,
        "Row1Col5": 467.961000,
        "Row1Col6": 9359.000000,
        "Row1Col7": null,
        "Row1Col8": null,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "ISIN:  INE860A01027",
        "Row2Col4": 1.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": -59.150000,
        "Row2Col10": 0.000000,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": "Sector: Technology Country: India Region:  Emerging markets",
        "Row3Col4": null,
        "Row3Col5": "2023-11-07",
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": 0
      },
      {
        "RecordId": 11,
        "TreeNodeId": 910,
        "TreeNodeSort": "00040-00070",
        "Lvl1NodeOrder": 40,
        "TreeRuleDisplayName1": "Equities",
        "Lvl2NodeOrder": 70,
        "TreeRuleDisplayName2": "United States",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "USD",
        "Row1Col2": 5000.000000,
        "Row1Col3": "APPLE INC.",
        "Row1Col4": 5500.000000,
        "Row1Col5": 253.480000,
        "Row1Col6": 1267400.000000,
        "Row1Col7": null,
        "Row1Col8": null,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "ISIN:  US0378331005",
        "Row2Col4": 0.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": -95.390000,
        "Row2Col10": 0.000000,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": "Sector: Technology Country: United States Region:  USA",
        "Row3Col4": null,
        "Row3Col5": "2024-12-17",
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": 0
      },
      {
        "RecordId": 12,
        "TreeNodeId": 910,
        "TreeNodeSort": "00040-00070",
        "Lvl1NodeOrder": 40,
        "TreeRuleDisplayName1": "Equities",
        "Lvl2NodeOrder": 70,
        "TreeRuleDisplayName2": "United States",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "USD",
        "Row1Col2": 30.000000,
        "Row1Col3": "MICROSOFT CORPORATION",
        "Row1Col4": 413.640000,
        "Row1Col5": 454.460000,
        "Row1Col6": 13634.000000,
        "Row1Col7": null,
        "Row1Col8": null,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "ISIN:  US5949181045",
        "Row2Col4": 1.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.000000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": 9.870000,
        "Row2Col10": 0.000000,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": "Sector: Technology Country: United States Region:  USA",
        "Row3Col4": null,
        "Row3Col5": "2024-12-17",
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": 0,
      },
      {
        "RecordId": 13,
        "TreeNodeId": 898,
        "TreeNodeSort": "00030-00070",
        "Lvl1NodeOrder": 30,
        "TreeRuleDisplayName1": "Fixed Income",
        "Lvl2NodeOrder": 70,
        "TreeRuleDisplayName2": "Emerging Mkts Hard Ccy Inv. Grade",
        "Lvl3NodeOrder": null,
        "TreeRuleDisplayName3": null,
        "Lvl4NodeOrder": null,
        "TreeRuleDisplayName4": null,
        "ReportingTotalAsset": 58995.500000,
        "Row1Col1": "USD",
        "Row1Col2": 20.000000,
        "Row1Col3": "HCL AMERICA INC. 1.375% 2026/03/10",
        "Row1Col4": 90.690000,
        "Row1Col5": 90.690000,
        "Row1Col6": 18.000000,
        "Row1Col7": null,
        "Row1Col8": null,
        "Row1Col9": null,
        "Row1Col10": null,
        "Row1Col11": null,
        "Row2Col1": null,
        "Row2Col2": null,
        "Row2Col3": "ISIN:  USU2479QAA59 M. Dur.  2.75",
        "Row2Col4": 1.000000,
        "Row2Col5": 1.000000,
        "Row2Col6": 0.110000,
        "Row2Col7": null,
        "Row2Col8": null,
        "Row2Col9": 0.010000,
        "Row2Col10": 0.000000,
        "Row3Col1": null,
        "Row3Col2": null,
        "Row3Col3": "Rating: A- YTM:  4.8%",
        "Row3Col4": null,
        "Row3Col5": "2023-05-31",
        "Row3Col6": null,
        "Row3Col7": null,
        "Row3Col8": null,
        "Row3Col9": null,
        "Row3Col10": null,
        "EsgRatingGroupNr": 0
      }
      ],
    },
    "Message": {
      "MessageCode": 200,
      "Message": "Success",
    }
  };

  constructor(private financialDataService: FinancialDataService) { }

  ngOnInit(): void {
    this.financialDataService.treeData$
      .pipe(takeUntil(this.destroy$))
      .subscribe(data => {
        const flatData = this.flattenTree(data);
        this.dataSource.data = flatData;
        this.updateCategorySummaries();
      });

    this.loadData();
  }

  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();
  }

  loadData(): void {
    this.financialDataService.processApiData(this.sampleData);
  }

  onToggleNode(nodeId: string): void {
    this.financialDataService.toggleNode(nodeId);
  }

  expandAll(): void {
    this.financialDataService.expandAll();
  }

  collapseAll(): void {
    this.financialDataService.collapseAll();
  }

  private updateCategorySummaries(): void {
    this.categorySummaries = this.financialDataService.getCategorySummaries();
  }

  formatNumber(value: number | string | undefined | null, decimals: number = 0): string {
    if (value === undefined || value === null) return '';
    const numValue = typeof value === 'string' ? parseFloat(value) : value;
    if (isNaN(numValue)) return '';
    return numValue.toLocaleString('en-US', {
      minimumFractionDigits: decimals,
      maximumFractionDigits: decimals
    });
  }

  formatPercentage(value: number | undefined | null): string {
    if (value === undefined || value === null) return '';
    return value.toFixed(2) + '%';
  }

  private flattenTree(nodes: FinancialNode[]): FinancialNode[] {
    const result: FinancialNode[] = [];
    for (const node of nodes) {
      result.push(node);
      if (node.expanded && node.children) {
        result.push(...this.flattenTree(node.children));
      }
    }
    return result;
  }

  isNumber(value: any): boolean {
    return typeof value === 'number';
  }

  hasValue(value: any): boolean {
    return value !== null && value !== undefined;
  }

  copyToClipboard(text: string): void {
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
      // Optional: Add notification here if needed
      console.log('Copied to clipboard:', text);
    }).catch(err => {
      console.error('Failed to copy: ', err);
    });
  }
}
